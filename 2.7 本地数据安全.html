<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>2.7 本地数据安全</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="okbm" id="27-本地数据安全">2.7 本地数据安全</h1><div class="md-section-divider"></div><h2 data-anchor-id="4qmi" id="1全局文件可读可写">1.全局文件可读可写</h2><div class="md-section-divider"></div><h3 data-anchor-id="if3y" id="问题描述">问题描述</h3><blockquote data-anchor-id="ny9u" class="white-blockquote">
  <p>openFileOutput()方法可以用于把数据输出到文件中。示例如下：</p>
</blockquote><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="dmyi"><ol class="linenums"><li class="L0"><code><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> save</span><span class="pun">()</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">            </span><span class="typ">FileOutputStream</span><span class="pln"> outStream</span><span class="pun">=</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">openFileOutput</span><span class="pun">(“</span><span class="pln">a</span><span class="pun">.</span><span class="pln">txt</span><span class="pun">”,</span><span class="typ">Context</span><span class="pun">.</span><span class="pln">MODE_WORLD_READABLE</span><span class="pun">);</span></code></li><li class="L4"><code><span class="pln">            outStream</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">text</span><span class="pun">.</span><span class="pln">getText</span><span class="pun">().</span><span class="pln">toString</span><span class="pun">().</span><span class="pln">getBytes</span><span class="pun">());</span></code></li><li class="L5"><code><span class="pln">            outStream</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span></code></li><li class="L6"><code><span class="pln">            </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">makeText</span><span class="pun">(</span><span class="typ">MyActivity</span><span class="pun">.</span><span class="kwd">this</span><span class="pun">,”</span><span class="typ">Saved</span><span class="pun">”,</span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">LENGTH_LONG</span><span class="pun">).</span><span class="pln">show</span><span class="pun">();</span></code></li><li class="L7"><code><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">FileNotFoundException</span><span class="pln"> e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code><span class="pln">            </span><span class="kwd">return</span><span class="pun">;</span></code></li><li class="L9"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">IOException</span><span class="pln"> e</span><span class="pun">){</span></code></li><li class="L1"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">;</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L3"><code><span class="pln">    </span><span class="pun">}</span></code></li></ol></pre><blockquote data-anchor-id="6234" class="white-blockquote">
  <p>openfileOutput第一个参数用来指定文件名称，不能包含分隔符'/',文件不存在则会自动创建。文件保存在/data/data//files目录。 <br>
  第二个参数用于指定操作模式</p>
</blockquote><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="j788"><ol class="linenums"><li class="L0"><code><span class="typ">Context</span><span class="pun">.</span><span class="pln">MODE_PRIVATE    </span><span class="pun">=</span><span class="pln">  </span><span class="lit">0</span></code></li><li class="L1"><code><span class="typ">Context</span><span class="pun">.</span><span class="pln">MODE_APPEND    </span><span class="pun">=</span><span class="pln">  </span><span class="lit">32768</span></code></li><li class="L2"><code><span class="typ">Context</span><span class="pun">.</span><span class="pln">MODE_WORLD_READABLE </span><span class="pun">=</span><span class="pln">  </span><span class="lit">1</span></code></li><li class="L3"><code><span class="typ">Context</span><span class="pun">.</span><span class="pln">MODE_WORLD_WRITEABLE </span><span class="pun">=</span><span class="pln">  </span><span class="lit">2</span></code></li></ol></pre><blockquote data-anchor-id="79pu" class="white-blockquote">
  <p><strong>MODE_PRIVATE为默认模式</strong>，代表文件是私有数据只能应用本身访问。该模式下，写入的内容会覆盖原文件内容，如果想追加则需要使用MODE_APPEND模式。 <br>
  MODE_APPEND：模式会检查文件是否存在，存在就往文件追加内容，否则就创建新文件。 <br>
  MODE_WORLD_READABLE和MODE_WORLD_WRITEABLE用来控制其他应用是否有权限读写该文件。MODE_WORLD_READABLE表示当前文件是否可以被其他应用读取，MODE_WORLD_WRITEABLE：表示当前文件可以被其他应用写入。</p>
</blockquote><div class="md-section-divider"></div><h3 data-anchor-id="ie8n" id="危害">危害</h3><p data-anchor-id="hst4">攻击者可以恶意读写文件，破坏其文件完整性，获取敏感信息等。</p><div class="md-section-divider"></div><h3 data-anchor-id="s8ln" id="检测方法">检测方法</h3><blockquote data-anchor-id="xhvi" class="white-blockquote">
  <p>搜索getsharePreferences查看第二个参数值要为0。2或者3则cun存在相应安全问题</p>
</blockquote><div class="md-section-divider"></div><h3 data-anchor-id="noa8" id="修复建议">修复建议</h3><blockquote data-anchor-id="hz0e" class="white-blockquote">
  <p>在描述模式时，使用默认模式禁止使用MODE_WORLD_READABLE | MODE_WORLD_WRITEABLE模式</p>
</blockquote><div class="md-section-divider"></div><h2 data-anchor-id="czix" id="2私有文件泄露风险-getsharepreferences">2.私有文件泄露风险--getsharePreferences</h2><div class="md-section-divider"></div><h3 data-anchor-id="hkly" id="问题描述-1">问题描述</h3><blockquote data-anchor-id="fnjp" class="white-blockquote">
  <p>在使用getsharePreferences打开文件时第二个参数设置为MODE_WORLD_READABLE 或MODE_WORLD_WRITEABLE</p>
</blockquote><div class="md-section-divider"></div><h3 data-anchor-id="ynx6" id="危害-1">危害</h3><p data-anchor-id="idtw">当前文件可以被其他应用读取和写入，导致信息泄露，文件内容被篡改，影响应用程序的正常运行或者更严重的问题。</p><div class="md-section-divider"></div><h3 data-anchor-id="zbjm" id="检测方法-1">检测方法</h3><blockquote data-anchor-id="az7o" class="white-blockquote">
  <p>搜索getsharePreferences查看第二个参数值要为0。2或者3则cun存在相应安全问题</p>
</blockquote><div class="md-section-divider"></div><h3 data-anchor-id="rn7b" id="修复建议-1">修复建议</h3><blockquote data-anchor-id="q3s2" class="white-blockquote">
  <p>使用getSharedPreferences时第二个参数设置为MODE_PRIVATE。禁止使用MODE_WORLD_READABLE | MODE_WORLD_WRITEABLE模式 <br>
  使用一个叫secure preferences第三方保护库保存数据。在手机未被root的情况下，也不能完全保证应用的安全，但相比sharedPreferences可以较好的保护，并且开源。</p>
</blockquote><div class="md-section-divider"></div><h2 data-anchor-id="rq7w" id="3securerandom随机数漏洞">3.SecureRandom随机数漏洞</h2><div class="md-section-divider"></div><h3 data-anchor-id="rmxw" id="问题描述-2">问题描述</h3><blockquote data-anchor-id="z99t" class="white-blockquote">
  <p>在SecureRandom生成随机数时，如果不调用setSeed方法，SecureRandom会从系统中找到一个默认的随机源，每次生成随机数都会从这个随机源取seed。如果生成SecureRandom对象后马上调用setSeed方法。SecureRandom会用用户设置的seed代替默认的随机源。使得每次生成随机数时都是会使用相同的seed作为输入。从而导致生成的随机数是相同的。 <br>
  危险函数</p>
</blockquote><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="uymj"><ol class="linenums"><li class="L0"><code><span class="typ">SecureRandom</span><span class="pun">＃</span><span class="typ">SecureRandom</span><span class="pun">(</span><span class="kwd">byte</span><span class="pun">[]</span><span class="pln"> seed</span><span class="pun">)</span></code></li><li class="L1"><code><span class="typ">SecureRandom</span><span class="pun">＃</span><span class="pln">setSeed</span><span class="pun">(</span><span class="kwd">long</span><span class="pln"> seed</span><span class="pun">)</span></code></li><li class="L2"><code><span class="typ">SecureRandom</span><span class="pun">＃</span><span class="pln">setSeed</span><span class="pun">(</span><span class="kwd">byte</span><span class="pun">[]</span><span class="pln"> seed</span><span class="pun">)</span></code></li></ol></pre><p data-anchor-id="si4u">触发条件：</p><div class="md-section-divider"></div><h3 data-anchor-id="z8b1" id="检测方法-2">检测方法</h3><blockquote data-anchor-id="cty9" class="white-blockquote">
  <p>搜索setSeed函数，如果有则需要判断相关环境及随机数的固定</p>
</blockquote><div class="md-section-divider"></div><h3 data-anchor-id="g5rz" id="修复建议-2">修复建议</h3><blockquote data-anchor-id="12jp" class="white-blockquote">
  <p>不使用setSeed相关</p>
</blockquote></div>
</body>
</html>