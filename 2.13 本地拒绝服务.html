<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>本地拒绝服务</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="58i4" id="本地拒绝服务">本地拒绝服务</h1><div class="md-section-divider"></div><h2 data-anchor-id="79g4" id="问题描述">问题描述</h2><blockquote data-anchor-id="jpkw" class="white-blockquote">
  <p>Android应用使用intent机制在组件之间传递数据，如果应用在使用getIntnet(),getAction(),Intent.getXXXXExtra()获取到空数据，异常或者畸形数据没有进行异常捕获，应用就会发生Crash，应用不可使用（本地拒绝服务）。恶意应用可以通过向受害者应用发送此类空数据，异常或者畸形数据从而使应用产生本地拒绝服务。</p>
  
  <p>简单来说就是攻击者通过intent发送空数据，异常或者畸形数据导致其崩溃。本地拒绝服务漏洞不仅可以导致安全防护功能被绕过或失效（如杀毒应用，安全卫士，防盗锁屏等）。而且也可被竞争对手应用利用来攻击，使得自己的应用崩溃，造成不同程度的经济利益损失</p>
</blockquote><ul data-anchor-id="2o05">
<li>NullPointerException空数据异常：应用程序没有对getAction()等获取到的数据进行空指针判断，从而导致空指针异常而导致应用崩溃。</li>
<li>ClassCastException类型转换异常：程序没有对getSerializableExtra()等获取到的数据进行类型判断而进行强制类型转换，从而导致类型转换异常而导致应用崩溃。</li>
<li>IndexOutbound**数组越界异常：程序没有对getIntegerArrayListExtra()等获取到的数据数组元素大小的判断，从而导致数据越界访问而导致应用崩溃。</li>
<li>ClassNotfoundException异常：程序没有无法找到从getSerializableExtra()获取到的序列化类对象的类定义。因此发生类未定义的异常而导致应用崩溃。</li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="gvjt" id="风险等级">风险等级</h2><blockquote data-anchor-id="xwgx" class="white-blockquote">
  <p>low/中等</p>
</blockquote><div class="md-section-divider"></div><h2 data-anchor-id="ib5f" id="检测方法">检测方法</h2><div class="md-section-divider"></div><h3 data-anchor-id="48cl" id="空intent阶段">空intent阶段</h3><blockquote data-anchor-id="erkp" class="white-blockquote">
  <p>对于此部分的检测算是初级阶段。一般只是通过AndroidManifest.xml文件获取应用导出的组件。 <br>
  何为导出的组件？ <br>
  在配置文件中如果应用的组件android：exported属性显式指定为true,或者并没有显式指定为true/false。但是有intent-filter并指定了相应的Action,则此组件为导出的组件。 <br>
  可以使用adb命令发送空的intent给导出组件，捕获应用日志输出，查看是否有崩溃产生。</p>
</blockquote><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="9r2u"><ol class="linenums"><li class="L0"><code><span class="pln">adb shell am startservice </span><span class="pun">-</span><span class="pln">n xxx</span><span class="pun">.</span><span class="pln">xxx</span><span class="pun">.</span><span class="kwd">package</span><span class="pun">/</span><span class="pln">xxxx</span><span class="pun">.</span><span class="pln">xxx</span><span class="pun">.类名</span></code></li><li class="L1"><code><span class="pln">adb shell am broastcast </span><span class="pun">-</span><span class="pln">n</span></code></li><li class="L2"><code><span class="pln">xxx</span><span class="pun">.</span><span class="pln">xxx</span><span class="pun">.</span><span class="kwd">package</span><span class="pun">/</span><span class="pln">xxxx</span><span class="pun">.</span><span class="pln">xxx</span><span class="pun">.类名</span></code></li><li class="L3"><code><span class="pln">adb shell am start </span><span class="pun">-</span><span class="pln">n </span></code></li><li class="L4"><code><span class="pln">xxx</span><span class="pun">.</span><span class="pln">xxx</span><span class="pun">.</span><span class="kwd">package</span><span class="pun">/</span><span class="pln">xxxx</span><span class="pun">.</span><span class="pln">xxx</span><span class="pun">.类名</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="lvho" id="解析key值阶段">解析key值阶段</h3><blockquote data-anchor-id="ku0s" class="white-blockquote">
  <p>空intent导致的拒绝服务只是一小部分，还有类型转换异常，数组越界异常等导致的本地拒绝服务。在解析key值阶段需要分析组件代码是否使用一些关键函数。</p>
  
  <p>在Activity组件的onCreate()方法中，Service组件中的onBind()和onStartCommand()方法中，BroastcastReceiver组件的onReceive()方法中，如果组件没有做好权限控制，都可接受任意外部传过来的intent,通过查找getIntent，getAction（）和getXXExtra()这些关键函数，检测其是否有try/catch异常保护，如果没有则会有本地拒绝服务风险。</p>
  
  <p>在这一阶段需要找到关键函数的key值，Action值，不仅要找到，还要找到key对应的类型来组装adb命令，发送命令给安装好的应用测试。</p>
</blockquote><div class="md-section-divider"></div><h3 data-anchor-id="25fx" id="通用型拒绝服务阶段">通用型拒绝服务阶段</h3><p data-anchor-id="bjqh">15年，业界爆出了通用型拒绝服务，由于应用中使用了getSerializableExtra()的API。应用开发者没有对传入的数据作异常判断，恶意应用可以通过传入序列化数据，导致应用本地拒绝服务。此种方法传入的key值不管是否与漏洞应用相同，都会抛出类未定义的异常，相比解析key值阶段通用性大大得到了提高。 <br>
常用的手工检测poc代码如下：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="7gbc"><ol class="linenums"><li class="L0"><code><span class="kwd">static</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">SelfSerializableData</span><span class="pln"> </span><span class="kwd">implements</span><span class="pln"> </span><span class="typ">Serializable</span><span class="pun">{</span></code></li><li class="L1"><code><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> serialVersionUID</span><span class="pun">=</span><span class="lit">42L</span><span class="pun">;</span></code></li><li class="L2"><code><span class="kwd">public</span><span class="pln"> </span><span class="typ">SelfSerializableData</span><span class="pun">()</span></code></li><li class="L3"><code><span class="pun">{</span><span class="kwd">super</span><span class="pun">();}</span></code></li><li class="L4"><code><span class="pun">....</span></code></li><li class="L5"><code><span class="pun">....</span></code></li><li class="L6"><code><span class="pun">构造畸形</span><span class="typ">Intent</span></code></li><li class="L7"><code><span class="typ">Intent</span><span class="pln"> intent</span><span class="pun">=</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Intent</span><span class="pun">（）；</span></code></li><li class="L8"><code><span class="pln">intent</span><span class="pun">.</span><span class="pln">putExtra</span><span class="pun">(</span><span class="str">'serializable_key'</span><span class="pun">,</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">SelfSerializableData</span><span class="pun">());</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pun">针对</span><span class="typ">Activity</span></code></li><li class="L1"><code><span class="typ">ComponetName</span><span class="pln"> componentName</span><span class="pun">=</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ComponentName</span><span class="pun">(</span><span class="pln">packagename</span><span class="pun">,</span><span class="pln">activityname</span><span class="pun">);</span></code></li><li class="L2"><code><span class="pln">intent</span><span class="pun">.</span><span class="pln">setComponent</span><span class="pun">(</span><span class="pln">componentName</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">startActivity</span><span class="pun">(</span><span class="pln">intent</span><span class="pun">)</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pun">针对</span><span class="typ">Service</span></code></li><li class="L6"><code><span class="typ">ComponentName</span><span class="pln"> componentName</span><span class="pun">=</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ComponentName</span><span class="pun">(</span><span class="pln">packageName</span><span class="pun">,</span><span class="typ">ServiceName</span><span class="pun">);</span></code></li><li class="L7"><code><span class="pln">intent</span><span class="pun">.</span><span class="pln">setComponent</span><span class="pun">(</span><span class="pln">componentName</span><span class="pun">);</span></code></li><li class="L8"><code><span class="pln">startService</span><span class="pun">(</span><span class="pln">intent</span><span class="pun">);</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pun">针对</span><span class="typ">BroadcastReceiver</span></code></li><li class="L1"><code><span class="pln">intent</span><span class="pun">.</span><span class="pln">setPackage</span><span class="pun">(</span><span class="pln">packageName</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">intent</span><span class="pun">.</span><span class="pln">setAction</span><span class="pun">(</span><span class="pln">actionName</span><span class="pun">)</span></code></li><li class="L3"><code><span class="pln">senBroadcast</span><span class="pun">(</span><span class="pln">intent</span><span class="pun">);</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="ee9m" id="修复建议">修复建议</h2><ul data-anchor-id="1yki">
<li>谨慎处理接收的intent以及携带的信息</li>
<li>对于接收的任何数据进行try/catch处理，对于不符合预期的数据做异常处理，异常包括但不限于：空指针异常，类型转换异常，数组越界访问异常，类未定义异常，序列化反序列化异常（getSerializableExtra,getParcelableExtra）</li>
</ul></div>
</body>
</html>