<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>2.12.6 WebView——同源策略绕过漏洞</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="1png" id="2126-webview同源策略绕过漏洞">2.12.6 WebView——同源策略绕过漏洞</h1><div class="md-section-divider"></div><h2 data-anchor-id="5kyz" id="问题描述">问题描述</h2><blockquote data-anchor-id="6dth" class="white-blockquote">
  <p>2013年10月份，外部爆出FireFox  Android版存在file域同源策略绕过漏洞，可造成cookie等敏感信息泄露，黑客可利用该漏洞获取FireFox的所有文件。低版本的Android系统WebView组件也存在同样的漏洞，应用程序一旦使用WebView并支持File域，就会受到该漏洞的攻击。该漏洞源于：JavaScript的延时执行能够绕过file策略的同源检查，并能够访问受害应用的所有私有文件，即通过WebView对Javascript的延时执行和将当前Html文件删除掉并软连接指向其他文件就可以读取到被符号链接所指的文件，然后通过JavaScript再次读取HTML文件，即可获取到被符号链接所指的文件。  <br>
      大多数使用WebView的应用都会受到该漏洞的影响，恶意应用通过该漏洞，可在无特殊权限下盗取应用的任意私有文件，尤其是浏览器，可通过利用该漏洞，获取到浏览器所保存的密码、Cookie、收藏夹以及历史记录等敏感信息，从而造成敏感信息泄露。</p>
</blockquote><div class="md-section-divider"></div><h3 data-anchor-id="8bt9" id="webview-file域同源策略绕过漏洞">WebView File域同源策略绕过漏洞</h3><blockquote data-anchor-id="vq4p" class="white-blockquote">
  <p>浏览器有一个很重要的概念——同源策略(Same-Origin Policy)。所谓同源是指，域名，协议，端口相同。不同源的客户端脚本(JavaScript、ActionScript)在没明确授权的情况下，不能读写对方的资源。  <br>
      简单的来说，浏览器允许包含在页面A的脚本访问第二个页面B的数据资源，这一切是建立在A和B页面是同源的基础上。同源策略是由Netscape提出的一个著名的安全策略，现在所有支持JavaScript 的浏览器都会使用这个策略。 <br>
       实际上，这种策略只是一个规范，并不是强制要求，各大厂商的浏览器只是针对同源策略的一种实现。它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，则浏览器的正常功能可能都会受到影响。如果Web世界没有同源策略，当你登录FreeBuf账号并打开另一个站点时，这个站点上的JavaScript可以跨域读取你的FreeBuf账号数据，这样整个Web世界就无隐私可言了。 <br>
      在Android系统中，APP访问网页一般是使用浏览器或者是使用了Android系统内置的webview组件。如果WebView没有禁止使用file域并且WebView打开了对JavaScript的支持。通过WebView对Javascript的延时执行和将当前Html文件删除掉并软连接指向其他文件就可以读取到被符号链接所指的文件，然后通过JavaScript再次读取HTML文件，即可获取到被符号链接所指的文件。 <br>
      利用WebView的File域协议读取任意可读文件或受害应用的私有文件。开启支持File域协议的WebView的Java代码片段：</p>
</blockquote><pre data-anchor-id="svxc"><code>利用WebView的File域协议读取任意可读文件或受害应用的私有文件。开启支持File域协议的WebView的Java代码片段：
</code></pre><p data-anchor-id="obvv"><img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/1.png" alt="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/1.png" title=""></p><p data-anchor-id="vtu7">用以下命令查看hosts文件“/system/etc/hosts”: <br>
<img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/2.png" alt="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/1.png" title=""> <br>
结果： <br>
<img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/3.png" alt="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/3.png" title=""></p><p data-anchor-id="ph5e">用命令查看应用私有文件“databases/webview.db”: <br>
<img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/4.png" alt="" title=""></p><p data-anchor-id="ziz7">结果： <br>
<img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/5.png" alt="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/5.png" title=""></p><p data-anchor-id="6oe4">利用file协议读取任意可读文件或受害应用的私有文件并上传至远程服务器（此处仅仅alert）。 开启支持JavaScript执行的WebView的Java代码片段： <br>
<img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/6.png" alt="" title=""></p><p data-anchor-id="kauh"><img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/7.png" alt="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/7.png"></p><p data-anchor-id="m5uk">用以下命令启动应用的WebView启动恶意HTML代码窃取文件:  <br>
<img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/8.png" alt="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/8.png" title=""> <br>
<img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/9.png" alt="" title=""> <br>
    利用WebView对Javascript的延时执行和将当前Html文件删除掉并软连接指向其他文件就可以读取到被符号链接所指的文件，然后通过JavaScript再次读取HTML文件，即可获取到被符号链接所指的文件，从而造成如所保存的密码、Cookie等敏感信息泄露。 <br>
     应用的主要Activity或导出的WebView Activity： <br>
<img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/10.png" alt="" title=""> <br>
 开启支持JavaScript执行的并未禁止File域协议的WebView的Java代码片段:  <br>
 <img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/11.png" alt="" title=""> <br>
 攻击WebView的构造的恶意HTML代码片段[1]: <br>
 <img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/12.png" alt="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/12.png" title=""> <br>
     攻击受害应用WebView的代码片段: <br>
<img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/13.png" alt="" title=""> <br>
    攻击结果如下图显示读取到了该受害应用的私有文件”databases/webview.db”，并可将其传送至远程服务器（此处仅仅alert）： <br>
<img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/14.png" alt=""></p><div class="md-section-divider"></div><h2 data-anchor-id="dkw5" id="风险等级">风险等级</h2><blockquote data-anchor-id="rov9" class="white-blockquote">
  <p>视情况而定</p>
</blockquote><div class="md-section-divider"></div><h2 data-anchor-id="81oh" id="检测方法">检测方法</h2><blockquote data-anchor-id="vxdb" class="white-blockquote">
  <p>检测类型：静态分析</p>
</blockquote><p data-anchor-id="45kv">遍历查找调用了setAllowFileAccess的类路径，然后再获取函数参数值，判断参数值是否为true；同时判断该类路径是否为导出的组件。若两个条件满足，则存在漏洞，否则安全。</p><div class="md-section-divider"></div><h2 data-anchor-id="p7rz" id="修复建议">修复建议</h2><ul data-anchor-id="w357">
<li>将不必要的组件设置为不导出，即android:exported="false"</li>
<li>如果需要导出组件，禁止使用File域，如果应用的需要导出包含WebView的组件，myWebview.getsetting.setAllowFileAccess(flase)</li>
<li>如果需要使用File协议，禁止File协议调用JavaScript。如果应用的WebView需要使用File协议，建议禁止File域协议调用avaScript： <br>
myWebView.getSettings. setJavaScriptEnabled(false);</li>
<li>如果即需要file协议，又需要js那么，需要判断加载的file是否为敏感的file：</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="hf89"><ol class="linenums"><li class="L0"><code><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onCreate</span><span class="pun">(</span><span class="typ">Bundle</span><span class="pln"> savedInstanceState</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onCreate</span><span class="pun">(</span><span class="pln">savedInstanceState</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln">        setContentView</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">layout</span><span class="pun">.</span><span class="pln">activity_main</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln">        </span><span class="typ">File</span><span class="pln"> f </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">File</span><span class="pun">(</span><span class="str">"/data/data/com.example.wifitongy</span></code></li><li class="L4"><code><span class="str">uan/tmp/A9527.html"</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln">        </span><span class="typ">System</span><span class="pun">.</span><span class="kwd">out</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">f</span><span class="pun">.</span><span class="pln">getAbsolutePath</span><span class="pun">());</span><span class="pln"> </span></code></li><li class="L6"><code><span class="pln">        </span><span class="typ">String</span><span class="pln"> absPath </span><span class="pun">=</span><span class="pln"> f</span><span class="pun">.</span><span class="pln">getAbsolutePath</span><span class="pun">();</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">absPath</span><span class="pun">.</span><span class="pln">contains</span><span class="pun">(</span><span class="str">";"</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pln">            </span><span class="com">// do nothing 返回不要进一步去检测这个文件，因为下</span></code></li><li class="L9"><code><span class="pun">面的命令会去执行其他的</span><span class="pln">linux</span><span class="pun">命令，如果在一个命令之后加上;</span><span class="pln"> </span></code></li><li class="L0"><code><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln">            </span><span class="typ">String</span><span class="pln"> fileInfo </span><span class="pun">=</span><span class="pln"> getShellExecuted</span><span class="pun">(</span><span class="str">"ls -</span></code></li><li class="L2"><code><span class="str">l  "</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> absPath</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln">            </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">e</span><span class="pun">(</span><span class="str">"zqx"</span><span class="pun">,</span><span class="pln"> fileInfo</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln">            </span><span class="typ">System</span><span class="pun">.</span><span class="kwd">out</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">fileInfo</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">fileInfo</span><span class="pun">.</span><span class="pln">trim</span><span class="pun">()).</span><span class="pln">startsWith</span><span class="pun">(</span><span class="str">"l"</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L6"><code><span class="pln">                </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">e</span><span class="pun">(</span><span class="str">"zq file type"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"this is a link file"</span></code></li><li class="L7"><code><span class="pun">);</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pln">                </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">fileInfo</span><span class="pun">.</span><span class="pln">contains</span><span class="pun">(</span><span class="str">"A9527"</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L9"><code><span class="pln">                    </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">e</span><span class="pun">(</span><span class="str">"zq file info"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"file is sensitiv</span></code></li><li class="L0"><code><span class="str">e "</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln">                </span><span class="pun">}</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln">            </span><span class="pun">}</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span></code></li><li class="L5"><code><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="typ">String</span><span class="pln"> getShellExecuted</span><span class="pun">(</span><span class="typ">String</span><span class="pln"> cmnd</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L6"><code><span class="pln">        </span><span class="typ">InputStream</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln">        </span><span class="typ">InputStreamReader</span><span class="pln"> insr </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pln">        </span><span class="typ">BufferedReader</span><span class="pln"> br </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span><span class="pln"> </span></code></li><li class="L9"><code><span class="pln">        </span><span class="typ">StringBuffer</span><span class="pln"> buff </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">StringBuffer</span><span class="pun">();</span><span class="pln"> </span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln">            </span><span class="com">/* Process process = Runtime.getRuntime().exec("sh /usr " + </span></code></li><li class="L2"><code><span class="com">cmnd); */</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln">            </span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> tmp </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">String</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="str">"/system/bin/sh"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"-c"</span><span class="pun">,</span><span class="pln"> cmnd </span><span class="pun">};</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln">            </span><span class="typ">Process</span><span class="pln"> process </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Runtime</span><span class="pun">.</span><span class="pln">getRuntime</span><span class="pun">().</span><span class="kwd">exec</span><span class="pun">(</span><span class="pln">tmp</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln">            process</span><span class="pun">.</span><span class="pln">waitFor</span><span class="pun">();</span><span class="pln"> </span></code></li><li class="L6"><code><span class="pln">            </span><span class="kwd">in</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> process</span><span class="pun">.</span><span class="pln">getInputStream</span><span class="pun">();</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln">            insr </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">InputStreamReader</span><span class="pun">(</span><span class="kwd">in</span><span class="pun">,</span><span class="pln"> </span><span class="str">"GBK"</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pln">            br </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">BufferedReader</span><span class="pun">(</span><span class="pln">insr</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L9"><code><span class="pln">            </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="pln">br</span><span class="pun">.</span><span class="pln">ready</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L0"><code><span class="pln">                </span><span class="typ">String</span><span class="pln"> line </span><span class="pun">=</span><span class="pln"> br</span><span class="pun">.</span><span class="pln">readLine</span><span class="pun">();</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln">                buff</span><span class="pun">.</span><span class="pln">append</span><span class="pun">(</span><span class="pln">line </span><span class="pun">+</span><span class="pln"> </span><span class="str">"\r\n"</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln">            </span><span class="pun">}</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Exception</span><span class="pln"> e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> buff</span><span class="pun">.</span><span class="pln">toString</span><span class="pun">();</span><span class="pln"> </span></code></li><li class="L6"><code><span class="pln">    </span><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="cus6">检测url的时候如果使用了startswith  那么” file”前面加一个空格就会绕过。不要用字符串的startsWith， 用uri-&gt;getscheme拿到scheme之后判断。如下图所示： <br>
<img src="https://raw.githubusercontent.com/BigFog/Photo_Save/master/APP%20evaluate%20photo/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E7%BB%95%E8%BF%87/15.png" alt=""></p><div class="md-section-divider"></div><h2 data-anchor-id="vc2q" id="参考链接">参考链接</h2><p data-anchor-id="30ok"><a href="http://jaq.alibaba.com/blog.htm?id=62" target="_blank">http://jaq.alibaba.com/blog.htm?id=62</a> <br>
<a href="http://www.tuicool.com/articles/Q36ZfuF" target="_blank">http://www.tuicool.com/articles/Q36ZfuF</a></p></div>
</body>
</html>