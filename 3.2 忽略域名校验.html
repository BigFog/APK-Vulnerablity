<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>3.2 忽略域名校验</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="ntrg" id="32-忽略域名校验">3.2 忽略域名校验</h1><div class="md-section-divider"></div><h2 data-anchor-id="smmh" id="问题描述">问题描述</h2><p data-anchor-id="ynlx">在自定义实现HostnameVerifier时，没有verify中进行严格证书校验，导致通信过程i中可能存在中间人攻击，造成敏感数据劫持危害。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="oa2e"><ol class="linenums"><li class="L0"><code><span class="typ">HostnameVerifier</span><span class="pln"> hv </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">HostnameVerifier</span><span class="pun">()</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pun">{</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln">    </span><span class="lit">@Override</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">boolean</span><span class="pln"> verify</span><span class="pun">(</span><span class="typ">String</span><span class="pln"> hostname</span><span class="pun">,</span><span class="pln"> </span><span class="typ">SSLSession</span><span class="pln"> session</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln">    </span><span class="pun">{</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln">        </span><span class="com">// Always return true -&gt; Accespt any host names </span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pun">};</span><span class="pln"> </span></code></li></ol></pre><p data-anchor-id="balj">在setHostnameVerifier方法中使用ALLOW_ALL_HOSTNAME_VERIFIER，信任所有Hostname，导致通信过程中可能存在中间人攻击，造成敏感数据劫持危害。</p><div class="md-section-divider"></div><h2 data-anchor-id="hbjy" id="风险等级">风险等级</h2><blockquote data-anchor-id="wt1q" class="white-blockquote">
  <p>视情况而定</p>
</blockquote><div class="md-section-divider"></div><h2 data-anchor-id="5bor" id="检测方法">检测方法</h2><blockquote data-anchor-id="4ap9" class="white-blockquote">
  <p>静态反编译，查找相关关键字</p>
</blockquote><div class="md-section-divider"></div><h2 data-anchor-id="a36a" id="修补建议">修补建议</h2><blockquote data-anchor-id="tghb" class="white-blockquote">
  <p>在自定义实现HostnameVerifier时，在verify中对Hostname进行严格校验。</p>
</blockquote><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="8cav"><ol class="linenums"><li class="L0"><code><span class="com">//获得密匙库 </span></code></li><li class="L1"><code><span class="pln">        </span><span class="typ">KeyStore</span><span class="pln"> trustStore </span><span class="pun">=</span><span class="pln"> </span><span class="typ">KeyStore</span><span class="pun">.</span><span class="pln">getInstance</span><span class="pun">(</span><span class="typ">KeyStore</span><span class="pun">.</span><span class="pln">getDefaultT</span></code></li><li class="L2"><code><span class="pln">ype</span><span class="pun">());</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln">        trustStore</span><span class="pun">.</span><span class="pln">load</span><span class="pun">(</span><span class="kwd">null</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">        </span><span class="typ">SSLSocketFactory</span><span class="pln"> sf </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">SSLSocketFactoryEx</span><span class="pun">(</span><span class="pln">trustStore</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L6"><code><span class="pln">        </span><span class="com">//信任所有主机名 </span></code></li><li class="L7"><code><span class="pln">        sf</span><span class="pun">.</span><span class="pln">setHostnameVerifier</span><span class="pun">(</span><span class="typ">SSLSocketFactory</span><span class="pun">.</span><span class="pln">ALLOW_ALL_HOSTNAME_VERI</span></code></li><li class="L8"><code><span class="pln">FIER</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">        </span><span class="typ">HttpParams</span><span class="pln"> </span><span class="kwd">params</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">BasicHttpParams</span><span class="pun">();</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln">        </span><span class="typ">HttpProtocolParams</span><span class="pun">.</span><span class="pln">setVersion</span><span class="pun">(</span><span class="kwd">params</span><span class="pun">,</span><span class="pln"> </span><span class="typ">HttpVersion</span><span class="pun">.</span><span class="pln">HTTP_1_1</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln">        </span><span class="typ">HttpProtocolParams</span><span class="pun">.</span><span class="pln">setContentCharset</span><span class="pun">(</span><span class="kwd">params</span><span class="pun">,</span><span class="pln"> HTTP</span><span class="pun">.</span><span class="pln">UTF_8</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">        </span><span class="typ">SchemeRegistry</span><span class="pln"> registry </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">SchemeRegistry</span><span class="pun">();</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln">        registry</span><span class="pun">.</span><span class="kwd">register</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Scheme</span><span class="pun">(</span><span class="str">"http"</span><span class="pun">,</span><span class="pln"> </span><span class="typ">PlainSocketFactory</span><span class="pun">.</span><span class="pln">getSock</span></code></li><li class="L6"><code><span class="pln">etFactory</span><span class="pun">(),</span><span class="pln"> </span><span class="lit">80</span><span class="pun">));</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln">        registry</span><span class="pun">.</span><span class="kwd">register</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Scheme</span><span class="pun">(</span><span class="str">"https"</span><span class="pun">,</span><span class="pln"> sf</span><span class="pun">,</span><span class="pln"> </span><span class="lit">443</span><span class="pun">));</span><span class="pln"> </span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">        </span><span class="typ">ClientConnectionManager</span><span class="pln"> ccm </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ThreadSafeClientConnManager</span><span class="pun">(</span><span class="pln">p</span></code></li><li class="L0"><code><span class="pln">arams</span><span class="pun">,</span><span class="pln"> registry</span><span class="pun">);</span><span class="pln"> </span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">DefaultHttpClient</span><span class="pun">(</span><span class="pln">ccm</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">params</span><span class="pun">);</span><span class="pln"> </span></code></li></ol></pre><p data-anchor-id="r31z">建议setHostnameVerifier方法中使用STRICT_HOSTNAME_VERIFIER进行严格证书校验，避免使用ALLOW_ALL_HOSTNAME_VERIFIER。 <br>
setHostnameVerifier(SSLSocketFactory.STRICT_HOSTNAME_VERIFIER);  </p></div>
</body>
</html>